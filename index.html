<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×× ×”×œ ×¤×•×¡×˜×™× ×œ×§×‘×•×¦×•×ª ×¤×™×™×¡×‘×•×§ (×œ×œ× ××•×˜×•××¦×™×”)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 16px;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    label {
      font-size: 13px;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }
    input, textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      font-family: inherit;
      font-size: 14px;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary {
      background: #0f766e;
      color: #fff;
    }
    button.secondary {
      background: #e4e4e7;
      color: #18181b;
    }
    button.danger {
      background: #dc2626;
      color: #fff;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e4e4e7;
      font-size: 11px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0,2fr) minmax(0,1.3fr);
      gap: 16px;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
      font-size: 12px;
    }
    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: #f4f4f5;
      border: 1px solid #e4e4e7;
    }
    .group-row {
      border: 1px solid #e4e4e7;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      background: #fafafa;
    }
    .group-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }
    .small {
      font-size: 12px;
      color: #52525b;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      border-radius: 999px;
      border: 1px solid #e4e4e7;
      font-size: 13px;
      cursor: pointer;
      background: #fafafa;
    }
    .tab.active {
      background: #0f766e;
      color: #fff;
      border-color: #0f766e;
    }
    .hidden {
      display: none;
    }
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
        <h1 style="margin:0;font-size:22px;">×× ×”×œ ×¤×•×¡×˜×™× ×œ×§×‘×•×¦×•×ª ×¤×™×™×¡×‘×•×§ (×œ×œ× ××•×˜×•××¦×™×”)</h1>
        <span class="badge">×©×•××¨ ×¢×œ ×›×œ×œ×™ ×¤×™×™×¡×‘×•×§</span>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="compose">âœï¸ × ×™×¡×•×— ××•×“×¢×”</div>
        <div class="tab" data-tab="groups">ğŸ‘¥ ×§×‘×•×¦×•×ª</div>
        <div class="tab" data-tab="run">ğŸš€ ×¨×™×¦×ª ×¤×¨×¡×•×</div>
        <div class="tab" data-tab="tests">âœ… ×‘×“×™×§×•×ª</div>
      </div>

      <!-- ×˜××‘ × ×™×¡×•×— ××•×“×¢×” -->
      <div class="tab-body" id="tab-compose">
        <div class="grid-2">
          <div>
            <h2>×ª×‘× ×™×ª ××•×“×¢×”</h2>
            <div class="row">
              <div style="flex:1">
                <label>×‘×—×™×¨×ª ×ª×‘× ×™×ª</label>
                <select id="presetSelect"></select>
              </div>
              <div style="display:flex;align-items:flex-end;gap:6px;">
                <button class="secondary" id="addPresetBtn">â• ×ª×‘× ×™×ª ×—×“×©×”</button>
                <button class="danger" id="deletePresetBtn">ğŸ—‘ ××—×§</button>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>
                <input type="checkbox" id="includeTitle" checked />
                ×œ×›×œ×•×œ ×›×•×ª×¨×ª ×‘×ª×—×™×œ×ª ×”××•×“×¢×”
              </label>
              <input id="presetTitle" placeholder="×›×•×ª×¨×ª (×œ××©×œ: ×œ×”×ª××”×‘ ×××‘×˜ ×¨××©×•×Ÿ)" />
            </div>

            <div style="margin-top:10px;">
              <label>×’×•×£ ×”××•×“×¢×” (×ª×•××š ×‘××©×ª× ×™× ×›××• {{×¢×™×¨}} {{××—×™×¨}} {{×—×“×¨×™×}})</label>
              <textarea id="presetBody"></textarea>
            </div>

            <div style="margin-top:10px;">
              <label>×”××©×˜×’×™×</label>
              <input id="presetTags" placeholder="#× ×“×œ×Ÿ #×“×™×¨×•×ª_×œ××›×™×¨×”" />
            </div>
          </div>

          <div>
            <h2>××©×ª× ×™× ××”×™×¨×™×</h2>
            <div id="varsContainer"></div>
            <div style="margin-top:8px;" class="row">
              <button class="secondary" id="resetVarsBtn">××™×¤×•×¡ ×‘×¨×™×¨×•×ª ××—×“×œ</button>
              <button class="secondary" id="addVarBtn">â• ×”×•×¡×£ ××©×ª× ×”</button>
            </div>

            <div style="margin-top:16px;">
              <h2>×˜×§×¡×˜ ××•×›×Ÿ ×œ×¤×¨×¡×•×</h2>
              <textarea id="compiledText" readonly></textarea>
              <div style="margin-top:8px;" class="row">
                <button class="primary" id="copyTextBtn">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ×˜××‘ ×§×‘×•×¦×•×ª -->
      <div class="tab-body hidden" id="tab-groups">
        <h2>× ×™×”×•×œ ×§×‘×•×¦×•×ª</h2>
        <div class="row" style="margin-bottom:10px;">
          <button class="primary" id="addGroupBtn">â• ×”×•×¡×£ ×§×‘×•×¦×”</button>
          <button class="secondary" id="exportGroupsBtn">â¬‡ ×™×¦×•× CSV</button>
          <label class="small">
            ×™×™×‘×•× CSV:
            <input type="file" id="importGroupsInput" accept=".csv" />
          </label>
        </div>
        <div id="groupsContainer"></div>
      </div>

      <!-- ×˜××‘ ×¨×™×¦×” -->
      <div class="tab-body hidden" id="tab-run">
        <h2>×¨×™×¦×ª ×¤×¨×¡×•× ×™×“× ×™×ª â€“ ×¦×¢×“ ××—×¨ ×¦×¢×“</h2>
        <ol class="small">
          <li>×‘×œ×©×•× ×™×ª "× ×™×¡×•×— ××•×“×¢×”" â€“ ×œ×—×¥ ×¢×œ "ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜".</li>
          <li>×›××Ÿ, ×œ×—×¥ ×¢×œ "×¤×ª×— ×§×‘×•×¦×”" ×¢×‘×•×¨ ×›×œ ×§×‘×•×¦×” ××•×›× ×”.</li>
          <li>×”×“×‘×§ ××ª ×”×˜×§×¡×˜ ×‘×¤×™×™×¡×‘×•×§, ×”×•×¡×£ ×ª××•× ×” ×× ×¦×¨×™×š ×•×¤×¨×¡×.</li>
          <li>××—×¨×™ ×”×¤×¨×¡×•×, ×œ×—×¥ "×¡××Ÿ ×›×¤×•×¡×˜" ×›×“×™ ×œ×ª×¢×“ ×ª××¨×™×š.</li>
        </ol>
        <div style="margin-top:10px;">
          <button class="secondary" id="copyFromRunBtn">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜ ×©×•×‘</button>
        </div>
        <h3 style="margin-top:16px;">×§×‘×•×¦×•×ª ××•×›× ×•×ª (×œ× ×‘×ª×§×•×¤×ª ×§×™×¨×•×¨)</h3>
        <div id="readyGroups"></div>
      </div>

      <!-- ×˜××‘ ×‘×“×™×§×•×ª -->
      <div class="tab-body hidden" id="tab-tests">
        <h2>×‘×“×™×§×•×ª ×œ×¤×•× ×§×¦×™×™×ª ×”×—×œ×¤×ª ××©×ª× ×™×</h2>
        <div id="testsContainer" class="small"></div>
      </div>
    </div>

    <div class="card">
      <h2>×˜×™×¤×™× ×œ×§×¦×‘ ×¤×¨×¡×•× × ×›×•×Ÿ</h2>
      <ul class="small">
        <li>×§×¨× ××ª ×›×œ×œ×™ ×›×œ ×§×‘×•×¦×” (××—×™×¨ ×—×•×‘×”, ×œ×œ× ×§×™×©×•×¨×™× ×•×›×•').</li>
        <li>×”×©××¨ ××¨×•×•×— ×–××Ÿ ×‘×™×Ÿ ×¤×¨×¡×•××™× ×“×•××™× ×›×“×™ ×œ×”×™×× ×¢ ××—×¡×™××•×ª.</li>
        <li>×¢×“×™×£ ×œ×¤×¨×¡× ×§×•×“× ×‘×¢××•×“ ×”×¢×¡×§×™ ×©×œ×š ×•××– ×œ×©×ª×£ ×œ×§×‘×•×¦×•×ª.</li>
        <li>×”×©×ª××© ×‘-UTM ×‘×§×™×©×•×¨×™× ×›×“×™ ×œ××“×•×“ ×ª× ×•×¢×” ×‘×’×•×’×œ ×× ×œ×™×˜×™×§×¡.</li>
      </ul>
    </div>
  </div>

  <script>
    // --------- State & helpers ----------
    const LS_GROUPS = "fb_group_poster_groups_simple";
    const LS_PRESETS = "fb_group_poster_presets_simple";
    const LS_VARS = "fb_group_poster_vars_simple";

    function load(key, fallback) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      } catch {
        return fallback;
      }
    }
    function save(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch {}
    }

    let groups = load(LS_GROUPS, []);
    let presets = load(LS_PRESETS, [
      {
        id: "default",
        name: "××•×“×¢×ª ×‘×¡×™×¡",
        title: "×œ×”×ª××”×‘ ×××‘×˜ ×¨××©×•×Ÿ",
        body:
          "×“×™×¨×ª 4 ×—×“×¨×™× ××©×•×¤×¦×ª, ××•××¨×ª ×•××•×©×§×¢×ª â€“ ×›× ×™×¡×” ××™×™×“×™×ª!\\n\\n" +
          "âœ” ××¨×¤×¡×ª ×©××© \\nâœ” ×—× ×™×” ×•××—×¡×Ÿ ×‘×˜××‘×• \\nâœ” ××˜×‘×— ××©×•×“×¨×’ ×¢× ×”××•×Ÿ ××—×¡×•×Ÿ \\n\\n" +
          "×œ×¤×¨×˜×™× ×•×”×ª×¨×©××•×ª: 050-000-0000",
        hashtags: "#× ×“×œ×Ÿ #×“×™×¨×•×ª_×œ××›×™×¨×” #×‘××¨_×™×¢×§×‘",
      },
    ]);
    let currentPresetId = presets[0]?.id || "default";
    let varsState = load(LS_VARS, {
      "×¢×™×¨": "×‘××¨ ×™×¢×§×‘",
      "××—×™×¨": "1,750,000",
      "×—×“×¨×™×": "4",
      "×©×›×•× ×”": "×”××§×œ×™×¤×˜×•×¡",
    });

    function replaceVars(text) {
      if (!text) return "";
      return text.replace(/\{\{(.*?)\}\}/g, function(_, key) {
        var k = String(key).trim();
        return varsState[k] || "";
      });
    }

    function hoursSince(iso) {
      if (!iso) return Infinity;
      var diff = Date.now() - new Date(iso).getTime();
      return Math.floor(diff / (1000 * 60 * 60));
    }

    // --------- DOM refs ----------
    var presetSelect = document.getElementById("presetSelect");
    var presetTitle = document.getElementById("presetTitle");
    var presetBody = document.getElementById("presetBody");
    var presetTags = document.getElementById("presetTags");
    var includeTitleCheckbox = document.getElementById("includeTitle");
    var varsContainer = document.getElementById("varsContainer");
    var compiledTextEl = document.getElementById("compiledText");
    var copyTextBtn = document.getElementById("copyTextBtn");
    var addPresetBtn = document.getElementById("addPresetBtn");
    var deletePresetBtn = document.getElementById("deletePresetBtn");
    var resetVarsBtn = document.getElementById("resetVarsBtn");
    var addVarBtn = document.getElementById("addVarBtn");
    var addGroupBtn = document.getElementById("addGroupBtn");
    var exportGroupsBtn = document.getElementById("exportGroupsBtn");
    var importGroupsInput = document.getElementById("importGroupsInput");
    var groupsContainer = document.getElementById("groupsContainer");
    var readyGroups = document.getElementById("readyGroups");
    var copyFromRunBtn = document.getElementById("copyFromRunBtn");
    var testsContainer = document.getElementById("testsContainer");

    // --------- Rendering ----------
    function getCurrentPreset() {
      return presets.find(function(p) { return p.id === currentPresetId; }) || presets[0];
    }

    function renderPresetsOptions() {
      presetSelect.innerHTML = "";
      presets.forEach(function(p) {
        var opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        presetSelect.appendChild(opt);
      });
      presetSelect.value = currentPresetId;
    }

    function renderPresetFields() {
      var p = getCurrentPreset();
      if (!p) return;
      presetTitle.value = p.title || "";
      presetBody.value = p.body || "";
      presetTags.value = p.hashtags || "";
      renderCompiledText();
    }

    function renderVars() {
      varsContainer.innerHTML = "";
      Object.keys(varsState).forEach(function(key) {
        var div = document.createElement("div");
        div.className = "row";
        div.style.marginBottom = "6px";

        var labelDiv = document.createElement("div");
        labelDiv.style.flex = "0 0 120px";
        labelDiv.innerHTML =
          '<div class="chip">{{' + key + '}}</div>' +
          '<div class="small">' + key + "</div>";

        var inputDiv = document.createElement("div");
        inputDiv.style.flex = "1";
        var inp = document.createElement("input");
        inp.value = varsState[key];
        inp.oninput = function(e) {
          varsState[key] = e.target.value;
          save(LS_VARS, varsState);
          renderCompiledText();
        };
        inputDiv.appendChild(inp);

        var btnDiv = document.createElement("div");
        btnDiv.style.flex = "0 0 auto";
        var delBtn = document.createElement("button");
        delBtn.textContent = "âœ–";
        delBtn.className = "secondary";
        delBtn.onclick = function() {
          delete varsState[key];
          save(LS_VARS, varsState);
          renderVars();
          renderCompiledText();
        };
        btnDiv.appendChild(delBtn);

        div.appendChild(labelDiv);
        div.appendChild(inputDiv);
        div.appendChild(btnDiv);
        varsContainer.appendChild(div);
      });
    }

    function renderCompiledText() {
      var p = getCurrentPreset();
      if (!p) return;
      var includeTitle = includeTitleCheckbox.checked;
      var titlePart = includeTitle && p.title ? "ã€" + replaceVars(p.title) + "ã€‘\\n\\n" : "";
      var bodyPart = replaceVars(p.body || "");
      var tagsPart = p.hashtags ? "\\n\\n" + p.hashtags : "";
      compiledTextEl.value = (titlePart + bodyPart + tagsPart).trim();
    }

    function renderGroups() {
      groupsContainer.innerHTML = "";
      groups.forEach(function(g, index) {
        var row = document.createElement("div");
        row.className = "group-row";

        var header = document.createElement("div");
        header.className = "group-row-header";

        var title = document.createElement("div");
        title.innerHTML =
          "<strong>" + (g.name || "×§×‘×•×¦×” ×œ×œ× ×©×") + "</strong><br>" +
          '<span class="small">' + (g.url || "") + "</span>";

        var buttons = document.createElement("div");
        var openBtn = document.createElement("button");
        openBtn.className = "secondary";
        openBtn.textContent = "×¤×ª×—";
        openBtn.onclick = function() {
          if (g.url) window.open(g.url, "_blank");
        };
        var delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "ğŸ—‘";
        delBtn.onclick = function() {
          groups.splice(index, 1);
          save(LS_GROUPS, groups);
          renderGroups();
          renderReadyGroups();
        };
        buttons.appendChild(openBtn);
        buttons.appendChild(delBtn);

        header.appendChild(title);
        header.appendChild(buttons);
        row.appendChild(header);

        var nameInput = document.createElement("input");
        nameInput.placeholder = "×©× ×”×§×‘×•×¦×”";
        nameInput.value = g.name || "";
        nameInput.oninput = function(e) {
          g.name = e.target.value;
          save(LS_GROUPS, groups);
          renderGroups();
          renderReadyGroups();
        };
        row.appendChild(nameInput);

        var urlInput = document.createElement("input");
        urlInput.placeholder = "×§×™×©×•×¨ ×œ×§×‘×•×¦×”";
        urlInput.value = g.url || "";
        urlInput.oninput = function(e) {
          g.url = e.target.value;
          save(LS_GROUPS, groups);
          renderReadyGroups();
        };
        row.appendChild(urlInput);

        var rulesInput = document.createElement("textarea");
        rulesInput.placeholder = "×”×¢×¨×•×ª/×›×œ×œ×™ ×”×§×‘×•×¦×” (×œ×œ× ×§×™×©×•×¨×™×? ××—×™×¨ ×—×•×‘×”? ×•×›×•')";
        rulesInput.value = g.rules || "";
        rulesInput.oninput = function(e) {
          g.rules = e.target.value;
          save(LS_GROUPS, groups);
        };
        row.appendChild(rulesInput);

        var smallRow = document.createElement("div");
        smallRow.className = "small";
        var cool = g.cooldownHours != null ? g.cooldownHours : 72;
        var last = g.lastPostedAt
          ? "×¤×•×¨×¡× ×œ××—×¨×•× ×”: " + new Date(g.lastPostedAt).toLocaleString("he-IL")
          : "×˜×¨× ×¤×•×¨×¡×";
        smallRow.textContent = "×©×¢×•×ª ×§×™×¨×•×¨: " + cool + " | " + last;
        row.appendChild(smallRow);

        groupsContainer.appendChild(row);
      });
    }

    function renderReadyGroups() {
      readyGroups.innerHTML = "";
      var nowReady = groups.filter(function(g) {
        var cool = g.cooldownHours != null ? g.cooldownHours : 72;
        return hoursSince(g.lastPostedAt) >= cool;
      });

      if (nowReady.length === 0) {
        var p = document.createElement("p");
        p.className = "small";
        p.textContent = "××™×Ÿ ×›×¨×’×¢ ×§×‘×•×¦×•×ª ××•×›× ×•×ª â€“ ×›× ×¨××” ×¢×“×™×™×Ÿ ×‘×ª×§×•×¤×ª ×§×™×¨×•×¨.";
        readyGroups.appendChild(p);
        return;
      }

      nowReady.forEach(function(g) {
        var row = document.createElement("div");
        row.className = "group-row";

        var header = document.createElement("div");
        header.className = "group-row-header";

        var title = document.createElement("div");
        title.innerHTML =
          "<strong>" + (g.name || "×§×‘×•×¦×” ×œ×œ× ×©×") + "</strong><br>" +
          '<span class="small">' + (g.url || "") + "</span>";

        var buttons = document.createElement("div");
        var openBtn = document.createElement("button");
        openBtn.className = "secondary";
        openBtn.textContent = "×¤×ª×— ×§×‘×•×¦×”";
        openBtn.onclick = function() {
          if (g.url) window.open(g.url, "_blank");
        };
        var markBtn = document.createElement("button");
        markBtn.className = "primary";
        markBtn.textContent = "×¡××Ÿ ×›×¤×•×¡×˜";
        markBtn.onclick = function() {
          g.lastPostedAt = new Date().toISOString();
          save(LS_GROUPS, groups);
          renderGroups();
          renderReadyGroups();
        };
        buttons.appendChild(openBtn);
        buttons.appendChild(markBtn);

        header.appendChild(title);
        header.appendChild(buttons);
        row.appendChild(header);

        readyGroups.appendChild(row);
      });
    }

    // --------- Tests ----------
    function renderTests() {
      var tests = [
        {
          name: "Basic replacement",
          template: "×©×œ×•× {{×©×}}",
          vars: { "×©×": "×©×—×¨" },
          expected: "×©×œ×•× ×©×—×¨",
        },
        {
          name: "Unknown variable becomes empty",
          template: "××—×™×¨: {{××—×™×¨}} ×©\"×—",
          vars: {},
          expected: "××—×™×¨:  ×©\"×—",
        },
        {
          name: "Multiple variables",
          template: "{{×—×“×¨×™×}} ×—×“' ×‘{{×¢×™×¨}}",
          vars: { "×—×“×¨×™×": "4", "×¢×™×¨": "×‘××¨ ×™×¢×§×‘" },
          expected: "4 ×—×“' ×‘×‘××¨ ×™×¢×§×‘",
        },
        {
          name: "Spaces around key",
          template: "×©×œ×•× {{ ×©× }}",
          vars: { "×©×": "Idan" },
          expected: "×©×œ×•× Idan",
        },
        {
          name: "No tokens",
          template: "×˜×§×¡×˜ ×¨×’×™×œ",
          vars: { a: "b" },
          expected: "×˜×§×¡×˜ ×¨×’×™×œ",
        },
        {
          name: "Repeated token",
          template: "{{×¢×™×¨}} {{×¢×™×¨}}",
          vars: { "×¢×™×¨": "×‘××¨ ×™×¢×§×‘" },
          expected: "×‘××¨ ×™×¢×§×‘ ×‘××¨ ×™×¢×§×‘",
        },
      ];

      testsContainer.innerHTML = "";
      tests.forEach(function(t) {
        var out = t.template.replace(/\{\{(.*?)\}\}/g, function(_, key) {
          var k = String(key).trim();
          return t.vars[k] || "";
        });
        var pass = out === t.expected;

        var wrap = document.createElement("div");
        wrap.style.border = "1px solid #e4e4e7";
        wrap.style.borderRadius = "10px";
        wrap.style.padding = "8px";
        wrap.style.marginBottom = "6px";

        wrap.innerHTML =
          '<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px;">' +
          (pass ? "âœ…" : "âŒ") +
          "<strong style=\"margin-right:6px;\">" + t.name + "</strong>" +
          '<span class="badge">' + (pass ? "PASS" : "FAIL") + "</span>" +
          "</div>" +
          "<div><strong>Template:</strong> " + t.template + "</div>" +
          "<div><strong>Vars:</strong> " + JSON.stringify(t.vars) + "</div>" +
          "<div><strong>Expected:</strong> " + t.expected + "</div>" +
          "<div><strong>Output:</strong> " + out + "</div>";

        testsContainer.appendChild(wrap);
      });
    }

    // --------- Events ----------
    presetSelect.onchange = function() {
      currentPresetId = presetSelect.value;
      save(LS_PRESETS, presets);
      renderPresetFields();
    };

    presetTitle.oninput = function() {
      var p = getCurrentPreset();
      if (!p) return;
      p.title = presetTitle.value;
      save(LS_PRESETS, presets);
      renderCompiledText();
    };

    presetBody.oninput = function() {
      var p = getCurrentPreset();
      if (!p) return;
      p.body = presetBody.value;
      save(LS_PRESETS, presets);
      renderCompiledText();
    };

    presetTags.oninput = function() {
      var p = getCurrentPreset();
      if (!p) return;
      p.hashtags = presetTags.value;
      save(LS_PRESETS, presets);
      renderCompiledText();
    };

    includeTitleCheckbox.onchange = function() {
      renderCompiledText();
    };

    copyTextBtn.onclick = function() {
      compiledTextEl.select();
      document.execCommand("copy");
      alert("×”×˜×§×¡×˜ ×”×•×¢×ª×§");
    };

    addPresetBtn.onclick = function() {
      var id = "preset_" + Date.now();
      presets.push({
        id: id,
        name: "×ª×‘× ×™×ª ×—×“×©×”",
        title: "",
        body: "×˜×§×¡×˜ ××•×“×¢×”...",
        hashtags: "",
      });
      currentPresetId = id;
      save(LS_PRESETS, presets);
      renderPresetsOptions();
      renderPresetFields();
    };

    deletePresetBtn.onclick = function() {
      if (presets.length <= 1) {
        alert("×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×›×œ ×”×ª×‘× ×™×•×ª");
        return;
      }
      presets = presets.filter(function(p) { return p.id !== currentPresetId; });
      currentPresetId = presets[0].id;
      save(LS_PRESETS, presets);
      renderPresetsOptions();
      renderPresetFields();
    };

    resetVarsBtn.onclick = function() {
      varsState = {
        "×¢×™×¨": "×‘××¨ ×™×¢×§×‘",
        "××—×™×¨": "1,750,000",
        "×—×“×¨×™×": "4",
        "×©×›×•× ×”": "×”××§×œ×™×¤×˜×•×¡",
      };
      save(LS_VARS, varsState);
      renderVars();
      renderCompiledText();
    };

    addVarBtn.onclick = function() {
      var key = prompt("×©× ××©×ª× ×” ×—×“×© (×œ××©×œ: ×§×•××”):");
      if (!key) return;
      if (varsState[key]) {
        alert("×›×‘×¨ ×§×™×™× ××©×ª× ×” ×‘×©× ×”×–×”");
        return;
      }
      varsState[key] = "";
      save(LS_VARS, varsState);
      renderVars();
      renderCompiledText();
    };

    addGroupBtn.onclick = function() {
      groups.push({
        name: "",
        url: "https://www.facebook.com/groups/",
        rules: "",
        cooldownHours: 72,
        lastPostedAt: null,
      });
      save(LS_GROUPS, groups);
      renderGroups();
      renderReadyGroups();
    };

    exportGroupsBtn.onclick = function() {
      var header = ["name","url","cooldownHours","rules","lastPostedAt"].join(",");
      var rows = groups.map(function(g) {
        return [
          g.name,
          g.url,
          g.cooldownHours != null ? g.cooldownHours : 72,
          (g.rules || "").replace(/\n/g," "),
          g.lastPostedAt || "",
        ].join(",");
      });
      var csv = [header].concat(rows).join("\n");
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "groups.csv";
      a.click();
      URL.revokeObjectURL(url);
    };

    importGroupsInput.onchange = function(e) {
      var file = e.target.files && e.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function() {
        var text = String(reader.result || "");
        var lines = text.split(/\r?\n/).filter(Boolean);
        if (!lines.length) return;
        var header = lines[0];
        var cols = header.split(",");
        lines.slice(1).forEach(function(line) {
          var parts = line.split(",");
          var obj = {};
          cols.forEach(function(c, i) { obj[c] = parts[i] || ""; });
          groups.push({
            name: obj.name || "",
            url: obj.url || "",
            cooldownHours: Number(obj.cooldownHours || 72),
            rules: obj.rules || "",
            lastPostedAt: obj.lastPostedAt || null,
          });
        });
        save(LS_GROUPS, groups);
        renderGroups();
        renderReadyGroups();
      };
      reader.readAsText(file);
    };

    copyFromRunBtn.onclick = function() {
      compiledTextEl.select();
      document.execCommand("copy");
      alert("×”×˜×§×¡×˜ ×”×•×¢×ª×§");
    };

    // Tabs switching
    document.querySelectorAll(".tab").forEach(function(tab) {
      tab.addEventListener("click", function() {
        var value = tab.getAttribute("data-tab");
        document.querySelectorAll(".tab").forEach(function(t) {
          t.classList.remove("active");
        });
        tab.classList.add("active");
        document.querySelectorAll(".tab-body").forEach(function(body) {
          body.classList.add("hidden");
        });
        document.getElementById("tab-" + value).classList.remove("hidden");
      });
    });

    // Init
    renderPresetsOptions();
    renderPresetFields();
    renderVars();
    renderGroups();
    renderReadyGroups();
    renderTests();
  </script>
</body>
</html>
