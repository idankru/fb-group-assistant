import React, { useEffect, useMemo, useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Checkbox } from "@/components/ui/checkbox";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import {
  Copy,
  ClipboardCheck,
  ExternalLink,
  Plus,
  Trash2,
  Clock,
  Upload,
  Download,
  ListChecks,
  Wand2,
  CheckCircle2,
  XCircle,
} from "lucide-react";

// ---------- LocalStorage helpers ----------
const LS_KEYS = {
  GROUPS: "fb_group_poster_groups",
  PRESETS: "fb_group_poster_presets",
};

function safeSave<T>(key: string, value: T) {
  try {
    if (typeof window === "undefined") return;
    window.localStorage.setItem(key, JSON.stringify(value));
  } catch {
    // ignore
  }
}

function safeLoad<T>(key: string, fallback: T): T {
  try {
    if (typeof window === "undefined") return fallback;
    const raw = window.localStorage.getItem(key);
    return raw ? (JSON.parse(raw) as T) : fallback;
  } catch {
    return fallback;
  }
}

// ---------- Types ----------
type Group = {
  id: string;
  name: string;
  url: string;
  rules?: string;
  cooldownHours?: number;
  lastPostedAt?: string | null;
  active?: boolean;
};

type Preset = {
  id: string;
  name: string;
  title?: string;
  body: string;
  hashtags?: string;
  imageUrl?: string;
  utmSource?: string;
  utmCampaign?: string;
  utmMedium?: string;
};

type TestCase = {
  name: string;
  template: string;
  vars: Record<string, string>;
  expected: string;
};

function uid() {
  return Math.random().toString(36).slice(2);
}

// ---------- Core replace function (pure) ----------
function replaceWithVars(template: string, vars: Record<string, string>): string {
  if (!template) return "";
  return template.replace(/\{\{(.*?)\}\}/g, (_, key) => {
    const k = String(key).trim();
    return vars[k] ?? "";
  });
}

// ---------- Default data ----------
const defaultPreset: Preset = {
  id: uid(),
  name: "××•×“×¢×ª ×‘×¡×™×¡",
  title: "×œ×”×ª××”×‘ ×××‘×˜ ×¨××©×•×Ÿ",
  body:
    "×“×™×¨×ª 4 ×—×“×¨×™× ××©×•×¤×¦×ª, ××•××¨×ª ×•××•×©×§×¢×ª â€“ ×›× ×™×¡×” ××™×™×“×™×ª!\n\n" +
    "âœ” ××¨×¤×¡×ª ×©××© \nâœ” ×—× ×™×” ×•××—×¡×Ÿ ×‘×˜××‘×• \nâœ” ××˜×‘×— ××©×•×“×¨×’ ×¢× ×”××•×Ÿ ××—×¡×•×Ÿ \n\n" +
    "×œ×¤×¨×˜×™× ×•×”×ª×¨×©××•×ª: 050-000-0000",
  hashtags: "#× ×“×œ×Ÿ #×“×™×¨×•×ª_×œ××›×™×¨×” #×‘××¨_×™×¢×§×‘",
  imageUrl: "",
  utmSource: "facebook",
  utmCampaign: "groups",
  utmMedium: "organic",
};

// ---------- Component ----------
export default function FBGroupAssistant() {
  // groups & presets
  const [groups, setGroups] = useState<Group[]>(() => safeLoad(LS_KEYS.GROUPS, [] as Group[]));
  const [presets, setPresets] = useState<Preset[]>(() => safeLoad(LS_KEYS.PRESETS, [defaultPreset] as Preset[]));
  const [currentPresetId, setCurrentPresetId] = useState<string>(() => presets[0]?.id || "");

  const currentPreset = useMemo(
    () => presets.find((p) => p.id === currentPresetId) || presets[0],
    [presets, currentPresetId]
  );

  // variable values used in templates
  const [vars, setVars] = useState<Record<string, string>>({
    ×¢×™×¨: "×‘××¨ ×™×¢×§×‘",
    ××—×™×¨: "1,750,000",
    ×—×“×¨×™×: "4",
    ×©×›×•× ×”: "×”××§×œ×™×¤×˜×•×¡",
  });

  const [includeTitle, setIncludeTitle] = useState(true);
  const [file, setFile] = useState<File | null>(null);

  // persist to localStorage
  useEffect(() => {
    safeSave(LS_KEYS.GROUPS, groups);
  }, [groups]);

  useEffect(() => {
    safeSave(LS_KEYS.PRESETS, presets);
  }, [presets]);

  // instance bound replace helper
  const replaceVars = (text?: string) => replaceWithVars(text || "", vars);

  // compiled post text
  const compiledText = useMemo(() => {
    if (!currentPreset) return "";
    const titlePart = includeTitle && currentPreset.title ? `ã€${replaceVars(currentPreset.title)}ã€‘\n\n` : "";
    const bodyPart = replaceVars(currentPreset.body);
    const tagsPart = currentPreset.hashtags ? `\n\n${currentPreset.hashtags}` : "";
    return `${titlePart}${bodyPart}${tagsPart}`.trim();
  }, [currentPreset, includeTitle, vars]);

  function copyToClipboard(text: string) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
      } else {
        // fallback
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
    } catch {
      // ignore
    }
  }

  function openGroup(g: Group) {
    if (!g.url) return;
    window.open(g.url, "_blank", "noopener,noreferrer");
  }

  function markPosted(groupId: string) {
    setGroups((prev) =>
      prev.map((g) => (g.id === groupId ? { ...g, lastPostedAt: new Date().toISOString() } : g))
    );
  }

  function hoursSince(iso?: string | null): number {
    if (!iso) return Infinity;
    const diff = Date.now() - new Date(iso).getTime();
    return Math.floor(diff / (1000 * 60 * 60));
  }

  const readyGroups = useMemo(() => {
    return groups.filter((g) => {
      if (g.active === false) return false;
      const cooldown = g.cooldownHours ?? 72;
      return hoursSince(g.lastPostedAt) >= cooldown;
    });
  }, [groups]);

  function addGroup() {
    setGroups((prev) => [
      ...prev,
      {
        id: uid(),
        name: "",
        url: "https://www.facebook.com/groups/",
        rules: "",
        cooldownHours: 72,
        lastPostedAt: null,
        active: true,
      },
    ]);
  }

  function removeGroup(id: string) {
    setGroups((prev) => prev.filter((g) => g.id !== id));
  }

  function addPreset() {
    const p: Preset = {
      id: uid(),
      name: "××•×“×¢×” ×—×“×©×”",
      body: "×˜×§×¡×˜ ××•×“×¢×”...",
    };
    setPresets((prev) => [...prev, p]);
    setCurrentPresetId(p.id);
  }

  function removePreset(id: string) {
    const index = presets.findIndex((p) => p.id === id);
    if (index === -1) return;
    const next = presets.filter((p) => p.id !== id);
    setPresets(next);
    if (currentPresetId === id) setCurrentPresetId(next[0]?.id || "");
  }

  function exportGroupsCSV() {
    const header = ["name", "url", "cooldownHours", "rules", "lastPostedAt", "active"].join(",");
    const rows = groups.map((g) =>
      [
        g.name,
        g.url,
        g.cooldownHours ?? 72,
        (g.rules || "").replace(/\n/g, " "),
        g.lastPostedAt || "",
        g.active !== false,
      ].join(",")
    );
    const csv = [header, ...rows].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "groups.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importGroupsCSV(file: File) {
    const reader = new FileReader();
    reader.onload = () => {
      const text = String(reader.result || "");
      const [header, ...lines] = text.split(/\r?\n/).filter(Boolean);
      const cols = header.split(",");
      const newGroups: Group[] = lines.map((line) => {
        const parts = line.split(",");
        const obj: Record<string, string> = {};
        cols.forEach((c, i) => {
          obj[c] = parts[i] ?? "";
        });
        return {
          id: uid(),
          name: obj.name || "",
          url: obj.url || "",
          cooldownHours: Number(obj.cooldownHours || 72),
          rules: obj.rules || "",
          lastPostedAt: obj.lastPostedAt || null,
          active: String(obj.active || "true") !== "false",
        } as Group;
      });
      setGroups((prev) => [...prev, ...newGroups]);
    };
    reader.readAsText(file);
  }

  // ---------- Test cases for replaceWithVars ----------
  const tests: TestCase[] = [
    {
      name: "Basic replacement",
      template: "×©×œ×•× {{×©×}}",
      vars: { ×©×: "×©×—×¨" },
      expected: "×©×œ×•× ×©×—×¨",
    },
    {
      name: "Unknown variable becomes empty",
      template: "××—×™×¨: {{××—×™×¨}} ×©\"×—",
      vars: {},
      expected: "××—×™×¨:  ×©\"×—",
    },
    {
      name: "Multiple variables",
      template: "{{×—×“×¨×™×}} ×—×“' ×‘{{×¢×™×¨}}",
      vars: { ×—×“×¨×™×: "4", ×¢×™×¨: "×‘××¨ ×™×¢×§×‘" },
      expected: "4 ×—×“' ×‘×‘××¨ ×™×¢×§×‘",
    },
    {
      name: "Spaces around key",
      template: "×©×œ×•× {{ ×©× }}",
      vars: { ×©×: "Idan" },
      expected: "×©×œ×•× Idan",
    },
    {
      name: "No tokens",
      template: "×˜×§×¡×˜ ×¨×’×™×œ",
      vars: { a: "b" },
      expected: "×˜×§×¡×˜ ×¨×’×™×œ",
    },
    {
      name: "Repeated token",
      template: "{{×¢×™×¨}} {{×¢×™×¨}}",
      vars: { ×¢×™×¨: "×‘××¨ ×™×¢×§×‘" },
      expected: "×‘××¨ ×™×¢×§×‘ ×‘××¨ ×™×¢×§×‘",
    },
  ];

  const testResults = useMemo(
    () =>
      tests.map((t) => {
        const out = replaceWithVars(t.template, t.vars);
        return { ...t, out, pass: out === t.expected };
      }),
    []
  );

  // ---------- JSX ----------
  return (
    <div className="p-6 max-w-6xl mx-auto space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">×× ×”×œ ×¤×•×¡×˜×™× ×œ×§×‘×•×¦×•×ª ×¤×™×™×¡×‘×•×§ (×œ×œ× ××•×˜×•××¦×™×”)</h1>
        <Badge>×©×•××¨ ×¢×œ ×›×œ×œ×™ ×¤×™×™×¡×‘×•×§</Badge>
      </div>

      <Tabs defaultValue="compose" className="w-full">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="compose">âœï¸ × ×™×¡×•×— ××•×“×¢×”</TabsTrigger>
          <TabsTrigger value="groups">ğŸ‘¥ ×§×‘×•×¦×•×ª</TabsTrigger>
          <TabsTrigger value="run">ğŸš€ ×¨×™×¦×ª ×¤×¨×¡×•× ×™×“× ×™×ª</TabsTrigger>
          <TabsTrigger value="tests">âœ… ×‘×“×™×§×•×ª</TabsTrigger>
        </TabsList>

        {/* Compose */}
        <TabsContent value="compose">
          <Card>
            <CardHeader>
              <CardTitle>××•×“×¢×”</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid md:grid-cols-3 gap-4">
                <div className="col-span-2 space-y-4">
                  <div className="flex items-center gap-2">
                    <Select value={currentPresetId} onValueChange={setCurrentPresetId}>
                      <SelectTrigger className="w-64">
                        <SelectValue placeholder="×‘×—×¨ ×ª×‘× ×™×ª" />
                      </SelectTrigger>
                      <SelectContent>
                        {presets.map((p) => (
                          <SelectItem key={p.id} value={p.id}>
                            {p.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <Button variant="secondary" onClick={addPreset}>
                      <Plus className="w-4 h-4 mr-1" /> ×ª×‘× ×™×ª ×—×“×©×”
                    </Button>
                    {currentPreset && (
                      <Button
                        variant="destructive"
                        onClick={() => removePreset(currentPreset.id)}
                      >
                        <Trash2 className="w-4 h-4 mr-1" /> ××—×§
                      </Button>
                    )}
                  </div>

                  {currentPreset && (
                    <div className="space-y-3">
                      <div className="flex items-center gap-2">
                        <Checkbox
                          checked={includeTitle}
                          onCheckedChange={(v) => setIncludeTitle(Boolean(v))}
                        />
                        <Input
                          placeholder="×›×•×ª×¨×ª (××•×¤×¦×™×•× ×œ×™, ×ª×•××š ×‘××©×ª× ×™× {{×¢×™×¨}} {{××—×™×¨}}...)"
                          value={currentPreset.title || ""}
                          onChange={(e) =>
                            setPresets((prev) =>
                              prev.map((p) =>
                                p.id === currentPreset.id
                                  ? { ...p, title: e.target.value }
                                  : p
                              )
                            )
                          }
                        />
                      </div>
                      <Textarea
                        className="min-h-[160px]"
                        placeholder="×’×•×£ ×”××•×“×¢×” â€“ ×ª×•××š ×‘××©×ª× ×™× ×œ××©×œ {{×¢×™×¨}}, {{××—×™×¨}}, {{×—×“×¨×™×}}, {{×©×›×•× ×”}}"
                        value={currentPreset.body}
                        onChange={(e) =>
                          setPresets((prev) =>
                            prev.map((p) =>
                              p.id === currentPreset.id
                                ? { ...p, body: e.target.value }
                                : p
                            )
                          )
                        }
                      />
                      <Input
                        placeholder="×”××©×˜×’×™× (#)"
                        value={currentPreset.hashtags || ""}
                        onChange={(e) =>
                          setPresets((prev) =>
                            prev.map((p) =>
                              p.id === currentPreset.id
                                ? { ...p, hashtags: e.target.value }
                                : p
                            )
                          )
                        }
                      />
                      <Input
                        placeholder="×§×™×©×•×¨ ×œ×ª××•× ×” (×œ× ×—×•×‘×”)"
                        value={currentPreset.imageUrl || ""}
                        onChange={(e) =>
                          setPresets((prev) =>
                            prev.map((p) =>
                              p.id === currentPreset.id
                                ? { ...p, imageUrl: e.target.value }
                                : p
                            )
                          )
                        }
                      />

                      <div className="grid grid-cols-3 gap-3">
                        <Input
                          placeholder="utm_source"
                          value={currentPreset.utmSource || ""}
                          onChange={(e) =>
                            setPresets((prev) =>
                              prev.map((p) =>
                                p.id === currentPreset.id
                                  ? { ...p, utmSource: e.target.value }
                                  : p
                              )
                            )
                          }
                        />
                        <Input
                          placeholder="utm_campaign"
                          value={currentPreset.utmCampaign || ""}
                          onChange={(e) =>
                            setPresets((prev) =>
                              prev.map((p) =>
                                p.id === currentPreset.id
                                  ? { ...p, utmCampaign: e.target.value }
                                  : p
                              )
                            )
                          }
                        />
                        <Input
                          placeholder="utm_medium"
                          value={currentPreset.utmMedium || ""}
                          onChange={(e) =>
                            setPresets((prev) =>
                              prev.map((p) =>
                                p.id === currentPreset.id
                                  ? { ...p, utmMedium: e.target.value }
                                  : p
                              )
                            )
                          }
                        />
                      </div>
                    </div>
                  )}
                </div>

                <div className="col-span-1 space-y-3">
                  <Card>
                    <CardHeader className="pb-2">
                      <CardTitle className="text-lg">××©×ª× ×™× ××”×™×¨×™×</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                      {Object.keys(vars).map((k) => (
                        <div key={k} className="flex items-center gap-2">
                          <Badge
                            variant="secondary"
                            className="min-w-20 text-center"
                          >
                            {"{{" + k + "}}"}
                          </Badge>
                          <Input
                            value={vars[k]}
                            onChange={(e) => setVars({ ...vars, [k]: e.target.value })}
                          />
                        </div>
                      ))}
                      <div className="flex gap-2">
                        <Button
                          variant="secondary"
                          onClick={() => setVars({ ...vars, ×—×“×©: "" })}
                        >
                          <Plus className="w-4 h-4 mr-1" /> ×”×•×¡×£ ××©×ª× ×”
                        </Button>
                        <Button
                          variant="outline"
                          onClick={() =>
                            setVars({
                              ×¢×™×¨: "×‘××¨ ×™×¢×§×‘",
                              ××—×™×¨: "1,750,000",
                              ×—×“×¨×™×: "4",
                              ×©×›×•× ×”: "×”××§×œ×™×¤×˜×•×¡",
                            })
                          }
                        >
                          ××™×¤×•×¡
                        </Button>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader className="pb-2">
                      <CardTitle className="text-lg">×˜×§×¡×˜ ××•×›×Ÿ ×œ×¤×¨×¡×•×</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                      <Textarea className="min-h-[180px]" readOnly value={compiledText} />
                      <div className="flex gap-2">
                        <Button onClick={() => copyToClipboard(compiledText)}>
                          <Copy className="w-4 h-4 mr-1" /> ×”×¢×ª×§ ×˜×§×¡×˜
                        </Button>
                        {currentPreset?.imageUrl && (
                          <Button
                            onClick={() =>
                              window.open(currentPreset.imageUrl as string, "_blank")
                            }
                          >
                            <ExternalLink className="w-4 h-4 mr-1" /> ×¤×ª×— ×ª××•× ×”
                          </Button>
                        )}
                      </div>
                    </CardContent>
                  </Card>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Groups */}
        <TabsContent value="groups">
          <Card>
            <CardHeader>
              <CardTitle>× ×™×”×•×œ ×§×‘×•×¦×•×ª</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex flex-wrap items-center gap-2">
                <Button onClick={addGroup}>
                  <Plus className="w-4 h-4 mr-1" /> ×”×•×¡×£ ×§×‘×•×¦×”
                </Button>
                <Button variant="secondary" onClick={exportGroupsCSV}>
                  <Download className="w-4 h-4 mr-1" /> ×™×¦×•× CSV
                </Button>
                <div className="flex items-center gap-2">
                  <Input
                    type="file"
                    accept=".csv"
                    onChange={(e) => setFile(e.target.files?.[0] || null)}
                    className="w-56"
                  />
                  <Button
                    variant="outline"
                    onClick={() => file && importGroupsCSV(file)}
                    disabled={!file}
                  >
                    <Upload className="w-4 h-4 mr-1" /> ×™×‘×•× CSV
                  </Button>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                {groups.map((g) => (
                  <Card key={g.id} className="border">
                    <CardContent className="pt-4 space-y-3">
                      <div className="grid grid-cols-12 gap-2 items-center">
                        <div className="col-span-6">
                          <Input
                            placeholder="×©× ×”×§×‘×•×¦×”"
                            value={g.name}
                            onChange={(e) =>
                              setGroups((prev) =>
                                prev.map((x) =>
                                  x.id === g.id ? { ...x, name: e.target.value } : x
                                )
                              )
                            }
                          />
                        </div>
                        <div className="col-span-6">
                          <Input
                            placeholder="×§×™×©×•×¨ ×œ×§×‘×•×¦×”"
                            value={g.url}
                            onChange={(e) =>
                              setGroups((prev) =>
                                prev.map((x) =>
                                  x.id === g.id ? { ...x, url: e.target.value } : x
                                )
                              )
                            }
                          />
                        </div>
                        <div className="col-span-12">
                          <Textarea
                            placeholder="×”×¢×¨×•×ª/×›×œ×œ×™ ×”×§×‘×•×¦×” (×œ×œ× ×§×™×©×•×¨×™×? ××—×™×¨ ×—×•×‘×”? ×•×›×•')"
                            value={g.rules || ""}
                            onChange={(e) =>
                              setGroups((prev) =>
                                prev.map((x) =>
                                  x.id === g.id ? { ...x, rules: e.target.value } : x
                                )
                              )
                            }
                          />
                        </div>
                        <div className="col-span-3 flex items-center gap-2">
                          <Clock className="w-4 h-4" />
                          <Input
                            type="number"
                            min={1}
                            value={g.cooldownHours ?? 72}
                            onChange={(e) =>
                              setGroups((prev) =>
                                prev.map((x) =>
                                  x.id === g.id
                                    ? { ...x, cooldownHours: Number(e.target.value) }
                                    : x
                                )
                              )
                            }
                          />
                          <span>×©×¢×•×ª ×§×™×¨×•×¨</span>
                        </div>
                        <div className="col-span-3 flex items-center gap-2">
                          <Switch
                            checked={g.active !== false}
                            onCheckedChange={(v) =>
                              setGroups((prev) =>
                                prev.map((x) =>
                                  x.id === g.id ? { ...x, active: Boolean(v) } : x
                                )
                              )
                            }
                          />
                          <span>×¤×¢×™×œ</span>
                        </div>
                        <div className="col-span-4 text-sm text-muted-foreground">
                          ×¤×•×¨×¡× ×œ××—×¨×•× ×”: {g.lastPostedAt ? new Date(g.lastPostedAt).toLocaleString() : "â€”"}
                        </div>
                        <div className="col-span-2 flex justify-end">
                          <Button variant="destructive" onClick={() => removeGroup(g.id)}>
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Run */}
        <TabsContent value="run">
          <Card>
            <CardHeader>
              <CardTitle>×¨×™×¦×ª ×¤×¨×¡×•× ×™×“× ×™×ª â€“ ×¦×¢×“ ××—×¨ ×¦×¢×“</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid md:grid-cols-3 gap-4">
                <div className="md:col-span-2 space-y-4">
                  <ol className="list-decimal mr-6 space-y-2 text-sm leading-6">
                    <li>
                      ×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×”××•×›×Ÿ (×›×¤×ª×•×¨ <strong>×”×¢×ª×§ ×˜×§×¡×˜</strong> ×‘×œ×©×•× ×™×ª
                      "××•×“×¢×”").
                    </li>
                    <li>
                      ×œ×—×¥ ×¢×œ <strong>×¤×ª×—</strong> ×œ×™×“ ×›×œ ×§×‘×•×¦×” â€“ ×™×™×¤×ª×— ×œ×š ×”×˜××‘ ×©×œ
                      ×”×§×‘×•×¦×” ×‘×¤×™×™×¡×‘×•×§.
                    </li>
                    <li>
                      ×”×“×‘×§ ××ª ×”×˜×§×¡×˜ ×‘×¢×•×¨×š ×©×œ ×¤×™×™×¡×‘×•×§. ×× ×¦×¨×™×š, ×”×•×¡×£ ×ª××•× ×” ×™×“× ×™×ª
                      ××”××—×©×‘/×§×™×©×•×¨.
                    </li>
                    <li>
                      ×¤×¨×¡×. ×œ××—×¨ ×”×¤×¨×¡×•×, ×œ×—×¥ ×¢×œ <strong>×¡××Ÿ ×›×¤×•×¡×˜</strong> ×›×“×™ ×œ×ª×¢×“
                      ××ª ×”×ª××¨×™×š.
                    </li>
                  </ol>
                </div>
                <div className="space-y-2">
                  <Button onClick={() => copyToClipboard(compiledText)} className="w-full">
                    <ClipboardCheck className="w-4 h-4 mr-1" /> ×”×¢×ª×§ ×”×›×œ
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => window.scrollTo({ top: 0, behavior: "smooth" })}
                    className="w-full"
                  >
                    <Wand2 className="w-4 h-4 mr-1" /> ×—×–×¨×” ×œ×œ×©×•× ×™×ª × ×™×¡×•×—
                  </Button>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                {readyGroups.length === 0 && (
                  <p className="text-sm text-muted-foreground">
                    ××™×Ÿ ×›×¨×’×¢ ×§×‘×•×¦×•×ª ××•×›× ×•×ª (×›× ×¨××” ×ª×—×ª ×ª×§×•×¤×ª ×§×™×¨×•×¨). × ×™×ª×Ÿ ×œ×¢×¨×•×š ××ª ×¢×¨×š
                    ×”×©×¢×•×ª ×‘×œ×©×•× ×™×ª ×§×‘×•×¦×•×ª.
                  </p>
                )}
                {readyGroups.map((g) => (
                  <Card key={g.id}>
                    <CardHeader className="pb-2 flex flex-row items-center justify-between">
                      <CardTitle className="text-base">{g.name || g.url}</CardTitle>
                      <Badge variant="secondary">
                        ×§×™×¨×•×¨: {g.cooldownHours ?? 72}×©×³
                      </Badge>
                    </CardHeader>
                    <CardContent className="flex gap-2">
                      <Button onClick={() => openGroup(g)} className="flex-1">
                        <ExternalLink className="w-4 h-4 mr-1" /> ×¤×ª×— ×§×‘×•×¦×”
                      </Button>
                      <Button variant="secondary" onClick={() => markPosted(g.id)}>
                        <ListChecks className="w-4 h-4 mr-1" /> ×¡××Ÿ ×›×¤×•×¡×˜
                      </Button>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Tests */}
        <TabsContent value="tests">
          <Card>
            <CardHeader>
              <CardTitle>×‘×“×™×§×•×ª ×¤×•× ×§×¦×™×™×ª ×”×—×œ×¤×ª ××©×ª× ×™× (replaceWithVars)</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {testResults.map((t) => (
                <div key={t.name} className="border rounded-xl p-3 text-sm">
                  <div className="flex items-center gap-2 mb-2">
                    {t.pass ? (
                      <CheckCircle2 className="w-4 h-4" />
                    ) : (
                      <XCircle className="w-4 h-4" />
                    )}
                    <strong>{t.name}</strong>
                    <Badge variant={t.pass ? "secondary" : "destructive"}>
                      {t.pass ? "PASS" : "FAIL"}
                    </Badge>
                  </div>
                  <div>
                    <strong>Template:</strong> {t.template}
                  </div>
                  <div>
                    <strong>Vars:</strong> {JSON.stringify(t.vars)}
                  </div>
                  <div>
                    <strong>Expected:</strong> {t.expected}
                  </div>
                  <div>
                    <strong>Output:</strong> {t.out}
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      <Card>
        <CardHeader>
          <CardTitle>×˜×™×¤×™× ×œ×§×¦×‘ ×¤×¨×¡×•× × ×›×•×Ÿ</CardTitle>
        </CardHeader>
        <CardContent>
          <ul className="list-disc mr-6 space-y-1 text-sm">
            <li>
              ×§×¨× ××ª ×›×œ×œ×™ ×›×œ ×§×‘×•×¦×” ×•×”×“×‘×§ ××ª ×”××•×“×¢×” ×‘×”×ª×× (×œ×“×•×’××”: ××—×™×¨ ×—×•×‘×”, ×œ×œ×
              ×§×™×©×•×¨×™× ×•×›×•').
            </li>
            <li>×”×©××¨ ××¨×•×•×—×™ ×–××Ÿ ×‘×™×Ÿ ×¤×¨×¡×•××™× ×“×•××™× ×›×“×™ ×œ×”×™×× ×¢ ××—×¡×™××•×ª.</li>
            <li>×¢×“×™×£ ×œ×¤×¨×¡× ×§×•×“× ×¤×•×¡×˜ ×‘×¢××•×“ ×”×¢×¡×§×™ ×©×œ×š ×•××– ×œ×©×ª×£ ×™×“× ×™×ª ×œ×§×‘×•×¦×•×ª.</li>
            <li>×©×ª×•×œ UTM ×‘×§×™×©×•×¨×™× ×›×“×™ ×œ××“×•×“ ×ª× ×•×¢×” ×‘×’×•×’×œ ×× ×œ×™×˜×™×§×¡.</li>
          </ul>
        </CardContent>
      </Card>
    </div>
  );
}
